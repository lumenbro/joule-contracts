name: Release & Verify

on:
  push:
    tags: ['v*']
  workflow_dispatch:
    inputs:
      release_name:
        description: 'Release name'
        required: true

permissions:
  id-token: write
  contents: write
  attestations: write

env:
  STELLAR_CLI_VERSION: "23.4.1"
  RUST_VERSION: "1.92.0"

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - package: joule-token
            dir: contracts/joule-token
          - package: rebalancer
            dir: contracts/rebalancer
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust ${{ env.RUST_VERSION }} and wasm32 target
        run: |
          rustup toolchain install ${{ env.RUST_VERSION }}
          rustup default ${{ env.RUST_VERSION }}
          rustup target add wasm32-unknown-unknown wasm32v1-none

      - name: Install Stellar CLI (prebuilt binary)
        run: |
          curl -fsSL "https://github.com/stellar/stellar-cli/releases/download/v${{ env.STELLAR_CLI_VERSION }}/stellar-cli-${{ env.STELLAR_CLI_VERSION }}-x86_64-unknown-linux-gnu.tar.gz" \
            | tar xz
          sudo mv stellar /usr/local/bin/
          stellar --version

      - name: Print versions
        run: |
          rustc --version
          cargo --version
          stellar --version

      - name: Build and optimize contract
        run: |
          stellar contract build --package ${{ matrix.package }} --optimize --out-dir out \
            --meta source_repo=github:${{ github.repository }} \
            --meta home_domain=lumenbro.com
          ls -la out/

      - name: Compute hash
        id: hash
        run: |
          # Cargo converts hyphens to underscores in output filenames
          WASM_NAME=$(echo "${{ matrix.package }}" | tr '-' '_')
          WASM_FILE="out/${WASM_NAME}.wasm"
          HASH=$(sha256sum "$WASM_FILE" | cut -d' ' -f1)
          echo "hash=$HASH" >> "$GITHUB_OUTPUT"
          echo "wasm_file=$WASM_FILE" >> "$GITHUB_OUTPUT"
          echo "WASM hash: $HASH"

      - name: Get package version
        id: meta
        run: |
          VERSION=$(cargo metadata --no-deps --format-version 1 | python3 -c "
          import json,sys
          data = json.load(sys.stdin)
          for p in data['packages']:
              if p['name'] == '${{ matrix.package }}':
                  print(p['version'])
          ")
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"

      - name: Prepare release artifact
        run: |
          cp "${{ steps.hash.outputs.wasm_file }}" "${{ matrix.package }}_v${{ steps.meta.outputs.version }}.wasm"

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}-${{ matrix.package }}
          name: "${{ matrix.package }} v${{ steps.meta.outputs.version }} (CLI ${{ env.STELLAR_CLI_VERSION }})"
          body: |
            ## ${{ matrix.package }} v${{ steps.meta.outputs.version }}

            Built with Stellar CLI ${{ env.STELLAR_CLI_VERSION }}

            **WASM SHA256:** `${{ steps.hash.outputs.hash }}`
          files: |
            ${{ matrix.package }}_v${{ steps.meta.outputs.version }}.wasm

      - name: Notify StellarExpert
        run: |
          curl -X POST "https://api.stellar.expert/explorer/public/contract-validation/match" \
            -H "Content-Type: application/json" \
            -d "{
              \"repository\": \"${{ github.server_url }}/${{ github.repository }}\",
              \"commitHash\": \"${{ github.sha }}\",
              \"jobId\": \"${{ github.job }}\",
              \"runId\": \"${{ github.run_id }}\",
              \"contractHash\": \"${{ steps.hash.outputs.hash }}\",
              \"packageName\": \"${{ matrix.package }}\"
            }" --max-time 15

      - name: Attest build provenance
        uses: actions/attest-build-provenance@v2
        with:
          subject-path: "${{ matrix.package }}_v${{ steps.meta.outputs.version }}.wasm"
